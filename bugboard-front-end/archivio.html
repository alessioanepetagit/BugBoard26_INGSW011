<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BugBoard26 - Archivio</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-archive"></i> Archivio Ticket</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="index.html" class="filter-btn" style="text-decoration:none; background: rgba(255,255,255,0.2); color: white;">
                <i class="fas fa-arrow-left"></i> Torna alla Board
            </a>
        </div>
    </header>

    <div id="archive-container" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <p style="text-align: center; color: #888;">Caricamento archivio in corso...</p>
    </div>
</div>

<script src="script.js"></script>

<script>
    // Funzione per caricare i ticket archiviati
    async function loadArchive() {
        try {
            // Chiamata al backend per recuperare tutti i ticket
            const response = await fetch(API_URL);
            const issues = await response.json();

            // Filtriamo solo i ticket con stato 'ARCHIVED'
            const archivedIssues = issues.filter(i => i.status === 'ARCHIVED');

            const container = document.getElementById('archive-container');
            container.innerHTML = '';

            // Gestione caso archivio vuoto
            if (archivedIssues.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 40px; color: #aaa;">
                        <i class="fas fa-box-open fa-3x" style="margin-bottom: 15px;"></i>
                        <h3>Nessun ticket in archivio</h3>
                        <p>I ticket archiviati dall'amministratore appariranno qui.</p>
                    </div>`;
                return;
            }

            // Crea la lista di card
            const list = document.createElement('div');
            list.style.display = 'flex';
            list.style.flexDirection = 'column';
            list.style.gap = '15px';

            archivedIssues.forEach(issue => {
                const item = document.createElement('div');
                // Utilizziamo le classi CSS delle card definite nello stile globale
                item.className = `card ${issue.type}`;
                item.style.borderLeftWidth = '5px';
                item.style.padding = '20px';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';

                const date = new Date(issue.createdAt).toLocaleDateString('it-IT');

                // Logica di Sicurezza: Solo l'ADMIN può vedere il tasto per ripristinare
                let actionButton = '';
                if (currentUser && currentUser.role === 'ADMIN') {
                    actionButton = `
                        <button onclick="restoreIssue(${issue.id})" class="filter-btn"
                                style="background: #27ae60; color: white; border: none; padding: 8px 15px;">
                            <i class="fas fa-undo"></i> Ripristina
                        </button>`;
                } else {
                    actionButton = '<span class="text-muted" style="font-size: 0.8em;"><i class="fas fa-lock"></i> Sola lettura</span>';
                }

                item.innerHTML = `
                    <div>
                        <div style="margin-bottom: 8px;">
                            <span class="badge bg-${issue.type}">${issue.type}</span>
                            <span style="font-weight:bold; color:#2c3e50; font-size: 1.15em; margin-left: 10px;">${issue.title}</span>
                        </div>
                        <div style="font-size: 0.95em; color: #555; margin-bottom: 8px;">
                            ${issue.description}
                        </div>
                        <div style="font-size: 0.8em; color: #888;">
                            <i class="far fa-calendar-alt"></i> Archiviato il: ${date} •
                            <i class="far fa-user"></i> Reporter: ${issue.reporter ? issue.reporter.email : 'N/A'}
                        </div>
                    </div>
                    <div>
                        ${actionButton}
                    </div>
                `;
                list.appendChild(item);
            });

            container.appendChild(list);

        } catch (error) {
            console.error("Errore nel caricamento dell'archivio:", error);
            document.getElementById('archive-container').innerHTML =
                '<p style="text-align:center; color:red;">Errore durante il caricamento dei dati.</p>';
        }
    }

    // Funzione per il ripristino sicuro (solo ADMIN)
    async function restoreIssue(id) {
        Swal.fire({
            title: 'Ripristinare il ticket?',
            text: "Il ticket tornerà visibile nella Dashboard principale.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#27ae60',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sì, ripristina!',
            cancelButtonText: 'Annulla'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // Chiamata all'endpoint specifico per il ripristino con header di sicurezza
                    const response = await fetch(`${API_URL}/${id}/restore`, {
                        method: 'PUT',
                        headers: {
                            'X-User-Role': currentUser.role
                        }
                    });

                    if (response.ok) {
                        Swal.fire('Ripristinato!', 'Il ticket è di nuovo attivo.', 'success');
                        loadArchive();
                    } else {
                        const errorMsg = await response.text();
                        Swal.fire('Errore', errorMsg, 'error');
                    }
                } catch(e) {
                    console.error(e);
                    Swal.fire('Errore', 'Connessione al server fallita.', 'error');
                }
            }
        });
    }

    // Sincronizzazione tema Dark Mode
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        const container = document.getElementById('archive-container');
        if(container) {
            container.style.backgroundColor = '#1e1e1e';
            container.style.color = '#e0e0e0';
        }
    }

    // Inizializzazione
    loadArchive();
</script>
</body>
</html>