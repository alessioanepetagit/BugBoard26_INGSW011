<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Archivio - BugBoard 26</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="container">
    <header>
        <h1>üì¶ Archivio Ticket</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="index.html" class="filter-btn" style="text-decoration:none; background: rgba(255,255,255,0.2); color: white;">‚¨Ö Torna alla Board</a>
        </div>
    </header>

    <div id="archive-container" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <p style="text-align: center; color: #888;">Caricamento archivio...</p>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api/issues';

    async function loadArchive() {
        try {
            const response = await fetch(API_URL);
            const issues = await response.json();

            // üîç FILTRO: Prendiamo SOLO quelli con status 'ARCHIVED'
            const archivedIssues = issues.filter(i => i.status === 'ARCHIVED');

            const container = document.getElementById('archive-container');
            container.innerHTML = '';

            if (archivedIssues.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding: 40px; color: #aaa;"><h3>üì≠ Nessun ticket in archivio</h3><p>Usa il tasto üì¶ nella dashboard per archiviare i ticket completati.</p></div>';
                return;
            }

            // Mostriamo i ticket archiviati
            const list = document.createElement('div');
            list.style.display = 'flex';
            list.style.flexDirection = 'column';
            list.style.gap = '15px';

            archivedIssues.forEach(issue => {
                const item = document.createElement('div');
                item.className = `card ${issue.type}`; // Usa lo stesso stile delle card
                item.style.borderLeftWidth = '5px';
                item.style.padding = '15px';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';

                // Data formattata
                const date = new Date(issue.createdAt).toLocaleDateString('it-IT');

                item.innerHTML = `
                    <div>
                        <div style="margin-bottom: 5px;">
                            <span class="badge bg-${issue.type}">${issue.type}</span>
                            <span style="font-weight:bold; color:#2c3e50; font-size: 1.1em; margin-left: 10px;">${issue.title}</span>
                        </div>
                        <div style="font-size: 0.9em; color: #666;">
                            ${issue.description}
                        </div>
                        <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                            üìÖ Creato il: ${date} ‚Ä¢ üë§ Reporter: ${issue.reporter ? issue.reporter.email : 'N/A'}
                        </div>
                    </div>
                    <div>
                        <button onclick="restoreIssue(${issue.id})" class="mini-btn" style="width: auto; padding: 5px 10px;" title="Ripristina nella Board">‚ôªÔ∏è Ripristina</button>
                    </div>
                `;
                list.appendChild(item);
            });

            container.appendChild(list);

        } catch (error) {
            console.error(error);
            document.getElementById('archive-container').innerText = "Errore caricamento archivio.";
        }
    }

    // --- FUNZIONE RIPRISTINO AGGIORNATA (SweetAlert) ---
    async function restoreIssue(id) {
        // Usiamo Swal.fire invece di confirm()
        Swal.fire({
            title: 'Ripristinare il ticket?',
            text: "Torner√† visibile nella Dashboard principale come 'Da Fare'.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'S√¨, ripristina!',
            cancelButtonText: 'Annulla'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // 1. Scarica i dettagli del ticket
                    const all = await (await fetch(API_URL)).json();
                    const issue = all.find(i => i.id === id);

                    if(issue) {
                        // 2. Lo rimettiamo in TODO
                        issue.status = 'TODO';

                        await fetch(API_URL + '/' + id, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(issue)
                        });

                        // 3. Successo e Ricarica
                        Swal.fire(
                            'Ripristinato!',
                            'Il ticket √® tornato nella Board.',
                            'success'
                        );
                        loadArchive();
                    }
                } catch(e) {
                    console.error(e);
                    Swal.fire('Errore', 'Impossibile ripristinare.', 'error');
                }
            }
        });
    }

    // Gestione Dark Mode anche qui
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        const container = document.getElementById('archive-container');
        if(container) {
            container.style.backgroundColor = '#1e1e1e';
            container.style.color = '#e0e0e0';
        }
    }

    loadArchive();
</script>
</body>
</html>